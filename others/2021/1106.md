---
theme: seriph
background: http://localhost:8888/69512535_p0.png
class: text-center
highlighter: shiki
---

# Koishi Talk

<div class="opacity-80">
16th / 2021-11-06
</div>

---

# Announcing Koishi v4 Beta üéâ

will be released around 11.10

- core: support class plugins
- cli: support `export default` plugins
- console: decoupling and enhancement
  - @koishijs/plugin-console
  - @koishijs/plugin-chat
  - @koishijs/plugin-manager: bots + settings + market
  - @koishijs/plugin-status: database + statistics + logs

---

# class plugins and export default plugins

```ts
// @koishijs/plugin-database-mysql
import { Context, Database } from 'koishi'

class MysqlDatabase extends Database {
  constructor(ctx: Context, config: MysqlDatabase.Config) {
    // prepare for database
  }
}

namespace MysqlDatabase {
  export const name = 'database-mysql'
  export const schema = Schema.object({})
  export interface Config {}
}

export default MysqlDatabase
```

```ts
import MysqlDatabase from '@koishijs/plugin-database-mysql'

app.plugin(MysqlDatabase, {
  ...
})
```

---

# RFC: console client API (entry file)

```ts
import * as client from '@koishijs/plugin-console/client'

// Êñ∞Â¢ûÈ°µÈù¢
client.addPage({
  path: '/market',
  name: 'Êèí‰ª∂Â∏ÇÂú∫',
  icon: 'puzzle-piece', // fontawesome ÂõæÊ†áÔºåÊú™Êù•ÂèØËÉΩ‰ºöË¶ÅÊ±ÇËá™Â∏¶Ôºü
  loading: ['market'], // ÈúÄË¶ÅËØ∑Ê±ÇÂêéÁ´ØÁöÑÂ≠óÊÆµÔºåÊ≤°ÊúâËØ•È°πÊï∞ÊçÆÊó∂ÊòæÁ§∫‰∏∫Âä†ËΩΩ‰∏≠
  component: () => import('./market.vue'),
})

// Êâ©Â±ïÁâπÂÆöËßÜÂõæÔºåÊØîÂ¶Ç live2d ‰∫∫Áâ©Á≠â
client.teleport({
  target: 'global',
  component,
})

// Êñ∞Â¢û‰∏ªÈ°µÂç°Áâá
client.addCard({
  type: 'numeric',
  order: 100,
  component,
})
```

---

# RFC: console client API (communication)

```vue
<template>
  <k-card title="ÂéÜÂè≤ÂèëË®ÄÊï∞Èáè">
    {{ store.history }}
  </k-card>
</template>

<script lang="ts" setup>
  import { store, emit, on } from '@koishijs/plugin-console/client'
</script>
```

- store: ÂêéÁ´ØÊï∞ÊçÆÔºàÁî± data ‰∫ã‰ª∂Êèê‰æõÔºâ
- emit: ÂêëÂêéÁ´ØÂèëÈÄÅ‰∫ã‰ª∂
- on: ‰ªéÂêéÁ´ØÊé•Êî∂‰∫ã‰ª∂

```ts
ctx.console.on()    // addListener
ctx.console.emit()  // broadcast
```

---

# RFC: console client API (data provider)

- ÂâçÁ´ØÔºöÁõ¥Êé•ËÆøÈóÆ `store.profile.cpuUsage`
- ÂêéÁ´Ø‰ª£Á†ÅÂ¶Ç‰∏ãÔºö

```ts
import { DataSource } from '@koishijs/plugin-console'

class ProfileProvider extends DataSource {
  constructor(ctx, config) {
    super(ctx, 'profile')

    ctx.on('connect', () => {
      ctx.setInterval(() => {
        this.broadcast()
      }, config.tickInterval)
    })
  }

  async get() {
    return { cpuUsage }
  }
}

ctx.plugin(ProfileProvider, config)
```

---

# Example: Declaration Merging

```ts
import { DataSource } from '@koishijs/plugin-console'

declare module '@koishijs/plugin-console' {
  namespace Console {
    interface Sources {
      profile: ProfileProvider
    }
  }
}

interface Payload {
  cpu: number
}

class ProfileProvider extends DataSource<Payload> {
  constructor(ctx, config) {
    super(ctx, 'profile')
  }
}
```

```ts
import { store } from '@koishijs/plugin-console/client'

store.value.profile // Payload
```

---

# Example Console Extension

### FILE STRUCTURE

```
src (-> lib)
  index.ts
client (-> dist)
  index.ts
```

### BACKEND

```ts
import {} from '@koishijs/plugin-console'

ctx.with(['console'], (ctx) => {
  const { devMode } = ctx.console.config
  const filename = devMode ? '../client/index.ts' : '../dist/index.js'
  ctx.addEntry(resolve(__dirname, filename))
})
```

### FRONTEND

```ts
import { addCard } from '@koishijs/plugin-console/client'

addCard({ ... })
```

---
layout: center
class: text-center
---

# Free Questions
